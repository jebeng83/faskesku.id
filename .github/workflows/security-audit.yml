name: Security Audit

on:
  push:
    branches: [ Algojo ]
  pull_request:
    branches: [ Algojo ]
  schedule:
    - cron: '0 3 * * 1' # Weekly, Monday 03:00 UTC

jobs:
  php-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Install dependencies (Composer)
        run: |
          composer install --no-interaction --no-progress --prefer-dist

      - name: Composer audit
        run: composer audit

  node-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (npm)
        run: |
          npm ci --ignore-scripts

      - name: NPM audit (moderate and above)
        run: npm audit --audit-level=moderate

      - name: React2Shell exposure scan
        run: npm run security:react2shell:scan

  quality-check:
    runs-on: ubuntu-latest
    env:
      QUALITY_GATE: soft # ubah menjadi 'strict' untuk memblokir build ketika ada error
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (npm)
        run: |
          npm ci

      - name: Lint
        run: npm run lint
        continue-on-error: ${{ env.QUALITY_GATE == 'soft' }}

      - name: Typecheck
        run: npm run typecheck
        continue-on-error: ${{ env.QUALITY_GATE == 'soft' }}
